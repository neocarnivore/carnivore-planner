<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<title>Carnivore Planner, Crafted by Neo</title>
<meta name="theme-color" content="#0b0b0f">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  :root{
    --bg:#0b0b0f;--card:#151821;--text:#e8eef6;--muted:#5c6e83;--acc:#48d1b5;--red:#ff7575;--input:#0f1218;--border:#23304a;
    --p:#2aa1ff;--f:#ffb454;--c:#48d1b5;--axis:rgba(255,255,255,.9);--grid:rgba(255,255,255,.12)
  }
  *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
  header{position:sticky;top:0;z-index:10;background:rgba(11,11,15,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:grid;gap:16px}
  @media(min-width:880px){.row{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
  h1{margin:0;font-size:18px;display:flex;align-items:center;gap:10px}
  .muted{color:var(--muted)}
  .grid{display:grid;gap:10px}
  .two{grid-template-columns:1fr 1fr}.three{grid-template-columns:repeat(3,1fr)}
  label{display:block;font-weight:600;margin-bottom:4px}
  input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--input);color:var(--text)}
  .tabs{display:flex;gap:8px}
  .tabs button{flex:1;padding:10px;border:1px solid var(--border);background:var(--input);color:var(--text);border-radius:8px;cursor:pointer}
  .tabs button.active{outline:2px solid var(--acc)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px}
  .badge.ok{background:rgba(72,209,181,.12)}
  .badge.warn{background:rgba(255,117,117,.12)}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .kpi .box{background:rgba(255,255,255,.04);padding:12px;border-radius:10px;border:1px solid var(--border)}
  .box h3{margin:0 0 8px 0;font-size:13px;color:var(--muted);font-weight:600}
  .num{font-size:20px;font-weight:700}
  canvas{width:100%;height:220px;background:linear-gradient(0deg, rgba(255,255,255,.02), transparent);border:1px solid var(--border);border-radius:10px}
  .rowbar{display:grid;grid-template-columns:120px 1fr 90px;gap:8px;align-items:center}
  .bar{height:8px;background:rgba(255,255,255,.08);border-radius:6px;position:relative}
  .bar>i{position:absolute;left:0;top:0;bottom:0;border-radius:6px;background:linear-gradient(90deg,var(--p),var(--f))}
  .note{font-size:12px;color:var(--muted)}
  .right{display:flex;gap:8px;align-items:center}
  .toggle{margin-left:auto}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;gap:12px">
    <h1>🥩 Carnivore Planner <span class="muted">— pFactor clamp & P:F guard</span></h1>
    <button id="themeBtn" class="badge toggle">🌓 Theme</button>
  </div>
</header>

<main class="wrap">
  <div class="row">
    <!-- Inputs -->
    <section class="card">
      <h2 style="margin-top:0">入力</h2>
      <div class="grid two">
        <div>
          <label for="weight">体重 (kg)</label>
          <input id="weight" type="number" inputmode="decimal" min="30" max="200" step="0.1" value="62">
        </div>
        <div>
          <label for="af">活動係数 (AF)</label>
          <select id="af">
            <option value="1.2">1.2（低）</option>
            <option value="1.6" selected>1.6（中）</option>
            <option value="2.0">2.0（高）</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>目標</label>
        <div class="tabs" id="goalTabs">
          <button data-goal="cut">減量</button>
          <button data-goal="maintain" class="active">維持</button>
          <button data-goal="bulk">増量</button>
        </div>
      </div>

      <div class="grid two" style="margin-top:10px">
        <div>
          <label for="pFactor">タンパク質係数 pFactor (g/kg)</label>
          <select id="pFactor">
            <!-- 既存UIを尊重：内部で clamp するので選択肢は自由 -->
            <option value="1.25">1.25（低）</option>
            <option value="1.56">1.56</option>
            <option value="1.88" selected>1.88（標準）</option>
            <option value="2.19">2.19</option>
            <option value="2.63">2.63（高）</option>
          </select>
        </div>
        <div>
          <label for="diet">食事タイプ</label>
          <select id="diet">
            <option value="Carnivore" selected>Carnivore</option>
            <option value="Ketovore">Ketovore</option>
            <option value="TKD">TKD</option>
          </select>
        </div>
      </div>

      <div class="grid two" id="carbRow" style="margin-top:10px;display:none">
        <div>
          <label for="carbIntake">炭水化物 (g/日)</label>
          <select id="carbIntake">
            <option value="30">30</option>
            <option value="50" selected>50</option>
            <option value="70">70</option>
          </select>
        </div>
        <div id="tkdBox" style="display:none">
          <label for="tkdOff">TKD オフ日</label>
          <select id="tkdOff">
            <option value="0" selected>いいえ</option>
            <option value="1">はい（半減）</option>
          </select>
        </div>
      </div>

      <div class="right" style="margin-top:12px">
        <span id="badgeClamp" class="badge ok" style="display:none">✅ pFactorを許容域に自動調整</span>
        <span id="badgeWarn" class="badge warn" style="display:none">⚠ 脂質フロア優先でP:F下限を割る可能性</span>
        <button id="calcBtn" style="margin-left:auto">計算する</button>
      </div>
      <p class="note" style="margin-top:8px">P:F（kcal）は常に 25–30% : 75–70% に投影（clamp）。グラフと合計kcalは常に K = E×W。</p>
    </section>

    <!-- Outputs -->
    <section class="card">
      <h2 style="margin-top:0">あなたの目安</h2>
      <div class="kpi" style="margin-bottom:10px">
        <div class="box"><h3>総カロリー K</h3><div class="num"><span id="kcalTotal">—</span> kcal/日</div><div class="note">K = E × 体重</div></div>
        <div class="box"><h3>E（kcal/kg）</h3><div class="num" id="E">—</div><div class="note" id="goalLabel">—</div></div>
        <div class="box"><h3>pFactor（実効）</h3><div class="num" id="pEff">—</div><div class="note">clamp後の値</div></div>
      </div>

      <div class="grid three">
        <div class="box">
          <h3>タンパク質</h3>
          <div class="num"><span id="P_g">—</span> g</div>
          <div class="note"><span id="P_kcal">—</span> kcal</div>
        </div>
        <div class="box">
          <h3>脂質</h3>
          <div class="num"><span id="F_g">—</span> g</div>
          <div class="note"><span id="F_kcal">—</span> kcal</div>
        </div>
        <div class="box">
          <h3>炭水化物</h3>
          <div class="num"><span id="C_g">—</span> g</div>
          <div class="note"><span id="C_kcal">—</span> kcal</div>
        </div>
      </div>

      <div style="margin-top:14px">
        <label>PFプール比率（P_kcal / (P_kcal+F_kcal)）</label>
        <div class="rowbar">
          <div class="note">目標 25–30%</div>
          <div class="bar"><i id="ratioBar" style="width:0%"></i></div>
          <div class="note"><span id="ratioTxt">—</span>%</div>
        </div>
      </div>
    </section>
  </div>

  <div class="row" style="margin-top:16px">
    <section class="card">
      <h2 style="margin-top:0">電解質（推定）</h2>
      <div class="grid three">
        <div class="box">
          <h3>カリウム</h3>
          <div class="num"><span id="K_mg">—</span> mg</div>
          <div class="note">≈ 50 mg/kg</div>
        </div>
        <div class="box">
          <h3>ナトリウム</h3>
          <div class="num"><span id="Na_mg">—</span> mg</div>
          <div class="note">低糖質なら +600mg, AF高なら +300mg</div>
        </div>
        <div class="box">
          <h3>マグネシウム</h3>
          <div class="num"><span id="Mg_mg">—</span> mg</div>
          <div class="note">≈ 6 mg/kg（AF高 +50mg）</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin-top:0">体重推移グラフ（Kベース）</h2>
      <canvas id="chart"></canvas>
      <p class="note">このグラフは常に K（E×W） を参照します。</p>
    </section>
  </div>
</main>

<script>
/* =========================
   設定とユーティリティ
========================= */
const IDMAP = {
  weight:'weight', af:'af', goalTabs:'goalTabs', pFactor:'pFactor',
  diet:'diet', carbRow:'carbRow', carbIntake:'carbIntake', tkdBox:'tkdBox', tkdOff:'tkdOff',
  calcBtn:'calcBtn', badgeClamp:'badgeClamp', badgeWarn:'badgeWarn',
  kcalTotal:'kcalTotal', E:'E', goalLabel:'goalLabel', pEff:'pEff',
  P_g:'P_g', P_kcal:'P_kcal', F_g:'F_g', F_kcal:'F_kcal', C_g:'C_g', C_kcal:'C_kcal',
  ratioBar:'ratioBar', ratioTxt:'ratioTxt',
  K_mg:'K_mg', Na_mg:'Na_mg', Mg_mg:'Mg_mg',
  chart:'chart', themeBtn:'themeBtn'
};
const $ = id => document.getElementById(IDMAP[id]);

const GOAL = {cut: {E:25, label:'減量'}, maintain:{E:30, label:'維持'}, bulk:{E:35, label:'増量'}};
let goal = 'maintain';

function getCarbs(diet){
  if(diet==='Carnivore') return 8;
  const c = +$('carbIntake').value;
  if(diet==='TKD'){
    const off = +$('tkdOff').value;
    return off ? Math.round(c*0.5) : c;
  }
  return c; // Ketovore
}

/* ============
   Clamp実装
==============*/
function computeMacros({W, goal, p_sel, C_g}) {
  const E = (goal==='cut')?25:(goal==='bulk')?35:30; // 減/増/維持
  const K = E * W;
  const C_kcal = 4 * C_g;
  let K_pf = K - C_kcal;

  const notes = [];
  if (K_pf < 0) { // 炭水化物が多すぎる場合の保護
    K_pf = 0; // PFプール消失
  }

  const r_lo = 0.25, r_hi = 0.30;
  const p_min = (K_pf>0)? (r_lo * K_pf) / (4 * W) : 0;
  const p_max = (K_pf>0)? (r_hi * K_pf) / (4 * W) : 0;

  let p = Math.max(p_min, Math.min(p_sel, p_max));
  if (p !== p_sel) notes.push('pFactorを許容域に自動調整');

  const P_g_raw = p * W;
  let P_kcal = 4 * P_g_raw;
  let F_kcal = Math.max(0, K_pf - P_kcal);
  let F_g = F_kcal / 9;

  // 脂質フロア
  const fat_floor = 0.6 * W;
  let warnPF=false;
  if (F_g < fat_floor) {
    // まず脂質をフロアまで引き上げる
    F_g = fat_floor;
    F_kcal = 9 * F_g;

    // PFプールが足りない場合、まずC_gを下限まで下げてPFプールを確保
    // 下限：Carnivore=0, それ以外=30
    const dietVal = $('diet').value;
    const Cmin = (dietVal==='Carnivore')? 0 : 30;
    if (K_pf < F_kcal) {
      // 必要PF = F_kcal、現在PF=K-C_kcal → C_kcalを減らす
      const K = E * W;
      let needCk = K - F_kcal; // PFをFで満たすための最大許容C_kcal
      let maxCk = Math.max(0, needCk);
      let c_now = 4 * C_g;
      let c_floor = 4 * Cmin;

      if (maxCk < c_now) {
        // 可能な限り炭水化物を減らす
        const c_new = Math.max(c_floor, maxCk);
        const newCg = Math.round(c_new/4);
        if (newCg !== C_g) {
          C_g = newCg;
          notes.push(`炭水化物を ${newCg}g に自動調整`);
        }
      }
      // 再計算
      const C_kcal2 = 4 * C_g;
      K_pf = Math.max(0, K - C_kcal2);
    }

    // フロア固定後のP再計算
    P_kcal = Math.max(0, K_pf - F_kcal);
    p = (P_kcal/4) / W;

    const r_now = (K_pf>0)? (P_kcal / K_pf) : 0;
    if (r_now < r_lo) { warnPF = true; notes.push('脂質フロア優先でP:F比が下限を下回り得る'); }
    // 上限を超えることはこの分岐では起きない（Fを増やしているため）
  }

  const out = {
    E, kcal_total: E*W,
    P_kcal, F_kcal, C_kcal: 4*C_g,
    P_g: P_kcal/4, F_g, C_g,
    pFactor: p,
    ratioPF: ( (P_kcal+F_kcal)>0 ? (P_kcal/(P_kcal+F_kcal)) : 0 ),
    notes, warnPF
  };
  return out;
}

/* ==================
   UI/状態管理
================== */
function setGoal(g){
  goal = g;
  [...$('goalTabs').children].forEach(b=>b.classList.toggle('active', b.dataset.goal===g));
  // pFactor選択肢はUIそのまま維持（内部clampで拘束）
}

function updateDietUI(){
  const d = $('diet').value;
  const showCarb = (d!=='Carnivore');
  $('carbRow').style.display = showCarb ? '' : 'none';
  $('tkdBox').style.display = (d==='TKD') ? '' : 'none';
}

function saveState(){
  const s = {
    W: +$('weight').value,
    af: +$('af').value,
    goal, p_sel: +$('pFactor').value,
    diet: $('diet').value,
    carb: +$('carbIntake').value,
    tkdOff: +$('tkdOff').value
  };
  sessionStorage.setItem('plannerAutoForm', JSON.stringify(s));
  sessionStorage.setItem('autocalc','1');
}

function restoreState(){
  const raw = sessionStorage.getItem('plannerAutoForm');
  if(!raw) return;
  try{
    const s = JSON.parse(raw);
    $('weight').value = s.W ?? 62;
    $('af').value = s.af ?? 1.6;
    $('pFactor').value = s.p_sel ?? 1.88;
    $('diet').value = s.diet ?? 'Carnivore';
    $('carbIntake').value = s.carb ?? 50;
    $('tkdOff').value = s.tkdOff ?? 0;
    setGoal(s.goal ?? 'maintain');
    updateDietUI();
  }catch(e){}
}

/* ==================
   電解質と分配
================== */
function electrolytes({W, C_g, AF}){
  const K = Math.round(50 * W); // mg
  const lowCarb = C_g <= 130;
  let Na = 60*W; // mg/kg基準
  if (lowCarb) Na += 600;
  if (AF>=1.55) Na += 300;
  let Mg = Math.round(6*W);
  if (AF>=1.55) Mg += 50;
  return {K:Math.round(K), Na:Math.round(Na), Mg:Math.round(Mg)};
}

/* ===============
   グラフ（K固定）
================ */
let chartCtx=null;
function drawChart(K){
  const c = $('chart');
  const dpr = Math.max(1, window.devicePixelRatio||1);
  const W = c.clientWidth, H = c.clientHeight;
  c.width = Math.round(W*dpr); c.height = Math.round(H*dpr);
  const ctx = c.getContext('2d');
  ctx.scale(dpr,dpr);
  // 背景グリッド
  ctx.strokeStyle = 'rgba(255,255,255,.12)';
  ctx.lineWidth = 1;
  for(let y=H-20; y>20; y-=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
  // Kの水平線（一定）
  ctx.strokeStyle = 'rgba(72,209,181,.9)';
  ctx.lineWidth = 2;
  const y = H - (H-40)*0.6; // 見栄え固定
  ctx.beginPath(); ctx.moveTo(10,y); ctx.lineTo(W-10,y); ctx.stroke();
  // テキスト
  ctx.fillStyle = 'rgba(255,255,255,.85)';
  ctx.font = '12px system-ui';
  ctx.fillText(`K = ${K} kcal/日`, 12, y-6);
  chartCtx = ctx;
}

/* =============
   メイン計算
===============*/
function calc(){
  const W = +$('weight').value;
  const AF = +$('af').value;
  const p_sel = +$('pFactor').value;
  const diet = $('diet').value;
  const C_g = getCarbs(diet);

  const rs = computeMacros({W, goal, p_sel, C_g});

  // バッジ
  $('badgeClamp').style.display = rs.notes.some(n=>n.includes('許容域に自動調整')) ? '' : 'none';
  $('badgeWarn').style.display  = rs.warnPF ? '' : 'none';

  // KPI
  $('kcalTotal').textContent = Math.round(rs.kcal_total);
  $('E').textContent = GOAL[goal].E;
  $('goalLabel').textContent = GOAL[goal].label;
  $('pEff').textContent = rs.pFactor.toFixed(2);

  // Macros
  $('P_g').textContent = Math.round(rs.P_g);
  $('P_kcal').textContent = Math.round(rs.P_kcal);
  $('F_g').textContent = Math.round(rs.F_g);
  $('F_kcal').textContent = Math.round(rs.F_kcal);
  $('C_g').textContent = Math.round(rs.C_g);
  $('C_kcal').textContent = Math.round(rs.C_kcal);

  // Ratio bar
  const r = rs.ratioPF*100;
  $('ratioBar').style.width = Math.max(0, Math.min(100, r)) + '%';
  $('ratioTxt').textContent = (isFinite(r)? r.toFixed(1) : '0.0');

  // 電解質
  const el = electrolytes({W, C_g:rs.C_g, AF});
  $('K_mg').textContent  = el.K;
  $('Na_mg').textContent = el.Na;
  $('Mg_mg').textContent = el.Mg;

  // グラフ（K固定）
  drawChart(Math.round(rs.kcal_total));

  // 状態保存（オート復元）
  saveState();
}

/* =============
   起動・イベント
===============*/
function bind(){
  // 目標タブ
  $('goalTabs').addEventListener('click', e=>{
    if(e.target.tagName!=='BUTTON') return;
    setGoal(e.target.dataset.goal);
    calc();
  });

  $('diet').addEventListener('change', ()=>{ updateDietUI(); calc(); });
  $('carbIntake').addEventListener('change', calc);
  $('tkdOff').addEventListener('change', calc);
  $('pFactor').addEventListener('change', calc);
  $('af').addEventListener('change', calc);
  $('weight').addEventListener('input', ()=>{ /*遅延せず即反映*/ });

  $('calcBtn').addEventListener('click', calc);

  // テーマ
  const themeKey='theme';
  const setTheme = (t)=>{ document.documentElement.dataset.theme=t; localStorage.setItem(themeKey,t); };
  const cur = localStorage.getItem(themeKey)||'dark';
  setTheme(cur);
  $('themeBtn').addEventListener('click', ()=>{ setTheme( (localStorage.getItem(themeKey)==='dark')?'light':'dark'); });

  // 初期化
  restoreState();
  updateDietUI();

  // autocalc
  const auto = sessionStorage.getItem('autocalc');
  calc();
  if(!auto){ sessionStorage.setItem('autocalc','1'); }
}

document.addEventListener('DOMContentLoaded', bind);
</script>
</body>
</html>
