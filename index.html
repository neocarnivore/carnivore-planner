<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carnivore Planner, Crafted by Neo</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #666;
      --accent: #0ea5e9;
      --card: #f8fafc;
      --border: #e5e7eb;
      --heading-weight: 700; /* 見出し太さの統一（④） */
      --section-title-weight: 700; /* 「基礎データ」「あなたの目安」など */
      --tab-weight: 600;
      --sticky-blur: 10px;
    }
    [data-theme="dark"] {
      --bg: #0b0f14;
      --fg: #e5e7eb;
      --muted: #9aa4b2;
      --accent: #38bdf8;
      --card: #0f1720;
      --border: #1f2a37;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      line-height: 1.6;
    }

    /* ② スティッキーヘッダー */
    .app-bar {
      position: sticky;
      top: 0;
      z-index: 999;
      backdrop-filter: saturate(1.2) blur(var(--sticky-blur));
      -webkit-backdrop-filter: saturate(1.2) blur(var(--sticky-blur));
      background: color-mix(in oklab, var(--bg) 85%, transparent);
      border-bottom: 1px solid var(--border);
    }
    .app-bar-inner {
      max-width: 960px;
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand {
      font-weight: var(--heading-weight);
      letter-spacing: 0.3px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .mode-buttons {
      display: flex;
      gap: 8px;
    }
    .btn {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--fg);
      cursor: pointer;
      font-weight: 600;
    }
    .btn:hover { border-color: var(--accent); }

    .container {
      max-width: 960px;
      margin: 20px auto 64px;
      padding: 0 16px;
    }

    .section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .section-title {
      margin: 0 0 12px;
      font-weight: var(--section-title-weight); /* 見出し太さ統一（④） */
      font-size: 18px;
    }

    /* 選択タブ（擬似タブ UI） */
    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 720px) {
      .grid { grid-template-columns: 1fr; }
    }
    .pill {
      display: flex;
      gap: 8px;
      align-items: center;
      border: 1px solid var(--border);
      background: var(--bg);
      padding: 10px 12px;
      border-radius: 12px;
    }
    .pill label {
      font-size: 12px;
      color: var(--muted);
      width: 88px;
      flex: 0 0 auto;
    }
    .pill select, .pill input {
      width: 100%;
      background: transparent;
      color: var(--fg);
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 8px;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 12px;
    }
    .btn-primary {
      background: var(--accent);
      color: #001018;
      border-color: var(--accent);
    }

    /* ④ 別タブレイアウト */
    .tabs {
      display: flex;
      gap: 6px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 10px;
    }
    .tab {
      padding: 10px 12px;
      cursor: pointer;
      border: 1px solid var(--border);
      border-bottom: none;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      background: var(--bg);
      color: var(--muted);
      font-weight: var(--tab-weight);
    }
    .tab.active {
      color: var(--fg);
      background: var(--card);
      border-color: var(--border);
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px dashed var(--border);
    }
    th { text-align: left; color: var(--muted); font-weight: 600; }

    /* ① 法的注記は常に黒 */
    .legal-note {
      margin-top: 16px;
      font-size: 12px;
      line-height: 1.5;
      color: #000 !important; /* ダークモードでも黒固定 */
      background: color-mix(in oklab, #fff 70%, transparent);
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px dashed #ccc;
    }
  </style>
</head>
<body data-theme="light">
  <!-- ② スクロール固定ヘッダー -->
  <header class="app-bar">
    <div class="app-bar-inner">
      <div class="brand">
        <span>Carnivore Planner, Crafted by Neo</span>
        <span class="brand-badge">v1.0</span>
      </div>
      <div class="mode-buttons">
        <button class="btn" id="lightBtn" aria-pressed="true">ライトモード</button>
        <button class="btn" id="darkBtn" aria-pressed="false">ダークモード</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- 基礎データ（見出し太さ統一 ④） -->
    <section class="section">
      <h2 class="section-title">基礎データ</h2>
      <div class="grid">
        <div class="pill">
          <label for="weight">体重(kg)</label>
          <input type="number" id="weight" min="30" max="200" step="0.1" placeholder="例: 68">
        </div>
        <div class="pill">
          <label for="height">身長(cm)</label>
          <input type="number" id="height" min="120" max="220" step="0.5" placeholder="例: 170">
        </div>
        <div class="pill">
          <label for="age">年齢</label>
          <input type="number" id="age" min="16" max="90" step="1" placeholder="例: 35">
        </div>
        <div class="pill">
          <label for="sex">性別</label>
          <select id="sex">
            <option value="">選択</option>
            <option value="male">男性</option>
            <option value="female">女性</option>
          </select>
        </div>
        <div class="pill">
          <label for="goal">目的</label>
          <select id="goal">
            <option value="">選択</option>
            <option value="cut">減量</option>
            <option value="maintain">維持</option>
            <option value="bulk">増量</option>
          </select>
        </div>
        <div class="pill">
          <label for="activity">活動量</label>
          <select id="activity">
            <option value="">選択</option>
            <option value="low">低い</option>
            <option value="mid">中</option>
            <option value="high">高い</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="resetBtn">リセット</button>
        <!-- ③ 計算→保存→リロードで数値反映 -->
        <button class="btn btn-primary" id="calcBtn">計算する</button>
      </div>
    </section>

    <!-- あなたの目安（見出し太さ統一 ④） -->
    <section class="section">
      <h2 class="section-title">あなたの目安</h2>
      <div id="summary">
        <p style="color: var(--muted); margin: 0;">
          体重・目的・活動量を選択して「計算する」を押すと、自動で再読込されて数値が反映されます（③）。
        </p>
      </div>
    </section>

    <!-- ④ 別タブレイアウト：食材別 vs 体重推移 -->
    <section class="section">
      <div class="tabs" role="tablist" aria-label="result-tabs">
        <button class="tab active" role="tab" aria-selected="true" aria-controls="tab-intake" id="tab-intake-btn">食材別の目安摂取量</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="tab-weight" id="tab-weight-btn">体重推移（推定）</button>
      </div>

      <div id="tab-intake" class="tab-panel active" role="tabpanel" aria-labelledby="tab-intake-btn">
        <table>
          <thead>
            <tr>
              <th>食材</th>
              <th>推定 1日目安量</th>
              <th>備考</th>
            </tr>
          </thead>
          <tbody id="intakeTable">
            <!-- JSで埋め込み -->
          </tbody>
        </table>
        <!-- ⑤ 食材別の下に代表値注記 -->
        <p style="margin-top:12px; font-size:12px; color: var(--muted);">
          ※100gあたり代表値（目安）：肉 220kcal / 魚介類 150kcal / 卵 150kcal / 乳製品 270kcal / 野菜 30kcal / 果物 60kcal
        </p>
      </div>

      <div id="tab-weight" class="tab-panel" role="tabpanel" aria-labelledby="tab-weight-btn">
        <table>
          <thead>
            <tr>
              <th>週</th>
              <th>推定体重(kg)</th>
              <th>コメント</th>
            </tr>
          </thead>
          <tbody id="weightTable">
            <!-- JSで埋め込み -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- ① 法的注記（常に黒） -->
    <div class="legal-note">
      ※各プランはカーニボア食・ケトジェニック食を支持する医師・医学博士らの文献・著書・研究のもと設計しています。<br>
      参考: Virta Health（YouTube） / The Noakes Foundation（YouTube）
    </div>
  </main>

  <script>
    // ===== ダーク/ライト切替（②） =====
    const body = document.body;
    const lightBtn = document.getElementById('lightBtn');
    const darkBtn  = document.getElementById('darkBtn');
    const THEME_KEY = 'cp_theme';

    function applyTheme(theme) {
      body.setAttribute('data-theme', theme);
      lightBtn.setAttribute('aria-pressed', theme === 'light');
      darkBtn.setAttribute('aria-pressed', theme === 'dark');
      localStorage.setItem(THEME_KEY, theme);
    }
    lightBtn.addEventListener('click', () => applyTheme('light'));
    darkBtn.addEventListener('click',  () => applyTheme('dark'));
    // 初期テーマ
    applyTheme(localStorage.getItem(THEME_KEY) || 'light');

    // ===== 入力/状態 =====
    const fields = {
      weight: document.getElementById('weight'),
      height: document.getElementById('height'),
      age: document.getElementById('age'),
      sex: document.getElementById('sex'),
      goal: document.getElementById('goal'),
      activity: document.getElementById('activity'),
    };
    const STATE_KEY = 'cp_state';
    const RELOAD_FLAG = 'cp_reload_after_calc';

    function saveState() {
      const state = {
        weight: fields.weight.value,
        height: fields.height.value,
        age: fields.age.value,
        sex: fields.sex.value,
        goal: fields.goal.value,
        activity: fields.activity.value,
      };
      localStorage.setItem(STATE_KEY, JSON.stringify(state));
    }
    function loadState() {
      const str = localStorage.getItem(STATE_KEY);
      if (!str) return;
      try {
        const s = JSON.parse(str);
        Object.keys(fields).forEach(k => {
          if (s[k] != null) fields[k].value = s[k];
        });
      } catch {}
    }
    loadState();

    // ===== 計算ロジック（簡易の例。既存計算がある場合は差し替え） =====
    function estimateMacros(state) {
      // 活動係数
      const act = { low: 1.5, mid: 1.75, high: 2.0 }[state.activity] || 1.6;
      const baseWeight = Number(state.weight) || 60;
      // ざっくりTDEE
      const tdee = Math.round(baseWeight * 22 * act);
      // 目的による調整
      const adj = state.goal === 'cut' ? -400 : state.goal === 'bulk' ? +300 : 0;
      const cal = Math.max(1200, tdee + adj);

      // カーニボア/ケトの比率（例）
      // 脂質 70%, たんぱく 30%（Pは4kcal/g, Fは9kcal/g）
      const fatCal = Math.round(cal * 0.70);
      const proCal = cal - fatCal;
      const fatG = Math.round(fatCal / 9);
      const proG = Math.round(proCal / 4);

      // 食材別配分（例: 肉/魚/卵/乳製品/野菜/果物）
      const kcalPer100 = { meat:220, fish:150, egg:150, dairy:270, veg:30, fruit:60 };
      // 動物性中心のサンプル配分
      const split = { meat:0.55, fish:0.20, egg:0.15, dairy:0.10, veg:0, fruit:0 };
      const intake = Object.fromEntries(
        Object.entries(split).map(([k, r]) => {
          const kc = Math.round(cal * r);
          const g100 = Math.round((kc / kcalPer100[k]) * 100); // 何gか
          return [k, { kcal: kc, grams: g100 }];
        })
      );

      return { cal, fatG, proG, intake };
    }

    // ===== ③ 計算ボタン→保存→フラグ→リロード =====
    const calcBtn = document.getElementById('calcBtn');
    const resetBtn = document.getElementById('resetBtn');
    calcBtn.addEventListener('click', () => {
      saveState();
      localStorage.setItem(RELOAD_FLAG, '1');
      // ここで実際にサーバ計算がある場合は先にPOSTしてからreloadでもOK
      location.reload(); // 押すたびにリロード（③）
    });
    resetBtn.addEventListener('click', () => {
      localStorage.removeItem(STATE_KEY);
      localStorage.removeItem(RELOAD_FLAG);
      Object.values(fields).forEach(el => el.value = '');
      document.getElementById('summary').innerHTML =
        '<p style="color: var(--muted); margin:0;">初期化しました。数値は未計算です。</p>';
      document.getElementById('intakeTable').innerHTML = '';
      document.getElementById('weightTable').innerHTML = '';
    });

    // ===== 起動時：フラグがあれば計算を反映（③） =====
    function renderAll() {
      const str = localStorage.getItem(STATE_KEY);
      if (!str) return;
      const state = JSON.parse(str);
      const res = estimateMacros(state);

      // あなたの目安
      document.getElementById('summary').innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;">
          <div class="pill"><label>推定カロリー</label><div>${res.cal} kcal/日</div></div>
          <div class="pill"><label>脂質</label><div>${res.fatG} g/日</div></div>
          <div class="pill"><label>たんぱく質</label><div>${res.proG} g/日</div></div>
        </div>
      `;

      // 食材別の目安摂取量（⑤の注記はHTML側に固定済み）
      const mapName = { meat:'肉', fish:'魚介類', egg:'卵', dairy:'乳製品', veg:'野菜', fruit:'果物' };
      const tbody = document.getElementById('intakeTable');
      tbody.innerHTML = '';
      ['meat','fish','egg','dairy','veg','fruit'].forEach(k=>{
        const it = res.intake[k];
        if (!it) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${mapName[k]}</td>
          <td>${it.grams} g / 日（約 ${it.kcal} kcal）</td>
          <td>${k==='veg'||k==='fruit' ? '任意（カーニボアでは通常少なめ）' : '推奨'}</td>
        `;
        tbody.appendChild(tr);
      });

      // 体重推移（推定）：超簡易モデル（参考値）
      const w0 = Number(state.weight) || 60;
      const deltaPerDay = (res.cal - (w0*22*1.6)) / 7700; // ざっくり 7700kcal=1kg
      const weightTable = document.getElementById('weightTable');
      weightTable.innerHTML = '';
      for (let week=0; week<=8; week+=1) {
        const d = week*7;
        const w = (w0 + deltaPerDay * d).toFixed(1);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${week} 週</td>
          <td>${w} kg</td>
          <td>${week===0?'開始時': (deltaPerDay<0?'緩やかに減少傾向':'やや増加傾向')}</td>
        `;
        weightTable.appendChild(tr);
      }
    }

    if (localStorage.getItem(RELOAD_FLAG) === '1') {
      // 計算要求後のリロード。描画してからフラグ解除。
      renderAll();
      localStorage.removeItem(RELOAD_FLAG);
    } else {
      // 通常ロード時も既存状態があれば描画（初回は空）
      renderAll();
    }

    // ===== ④ タブ切替 =====
    const tabIntakeBtn = document.getElementById('tab-intake-btn');
    const tabWeightBtn = document.getElementById('tab-weight-btn');
    const tabIntake = document.getElementById('tab-intake');
    const tabWeight = document.getElementById('tab-weight');
    function activateTab(which) {
      const isIntake = which === 'intake';
      tabIntakeBtn.classList.toggle('active', isIntake);
      tabWeightBtn.classList.toggle('active', !isIntake);
      tabIntake.classList.toggle('active', isIntake);
      tabWeight.classList.toggle('active', !isIntake);
      tabIntakeBtn.setAttribute('aria-selected', isIntake ? 'true':'false');
      tabWeightBtn.setAttribute('aria-selected', !isIntake ? 'true':'false');
    }
    tabIntakeBtn.addEventListener('click', ()=>activateTab('intake'));
    tabWeightBtn.addEventListener('click', ()=>activateTab('weight'));
  </script>
</body>
</html>
