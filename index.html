<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Carnivore Planner, Crafted by Neo</title>
<meta name="theme-color" content="#0b0b0f">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  :root{
    --bg:#0b0b0f;--card:#151821;--text:#e8eef6;--muted:#9fb0c3;--acc:#48d1b5;--red:#ff7575;--input:#0f1218;--border:#23304a;
    --p:#2aa1ff;--f:#ffb454;--c:#48d1b5;
    --axis:rgba(255,255,255,.9);--grid:rgba(255,255,255,.12);--axisLine:rgba(255,255,255,.35)
  }
  .light{
    --bg:#f6f8fb;--card:#ffffff;--text:#1a2732;--muted:#5c6e83;--acc:#0aa37f;--red:#d13b3b;--input:#ffffff;--border:#dfe8f2;
    --p:#0a84ff;--f:#ff9900;--c:#0aa37f;
    --axis:#13283d;--grid:rgba(19,40,61,.10);--axisLine:rgba(19,40,61,.35)
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#10131b00);color:var(--text)}
  header{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:16px 14px 6px;font-weight:800;font-size:clamp(16px,2.4vw,20px)}
  .wrap{padding:10px;max-width:1080px;margin:auto}
  .card{background:var(--card);border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 8px 24px rgba(0,0,0,.18);border:1px solid var(--border)}
  label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
  input,select,button{width:100%;padding:12px 10px;border-radius:10px;border:1px solid var(--border);background:var(--input);color:var(--text)}
  input::placeholder{color:#7e8ca1}
  button{cursor:pointer;background:var(--acc);border:none;color:#fff;font-weight:700}

  /* ===== 入力：常に2列ペア（端末崩れなし） ===== */
  .formGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .pair{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:430px){ .formGrid{grid-template-columns:1fr} }

  /* ===== 出力レイアウト（画像の並び） ===== */
  .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .kpi{background:var(--input);border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center}
  .kpi b{display:block;font-size:18px;margin-top:2px}
  .big{font-size:clamp(22px,4vw,28px);font-weight:900;color:var(--acc)}
  .small{font-size:12px;color:var(--muted)}
  .warn{color:var(--red);font-size:12px;margin-top:6px}

  /* 棒グラフ：ライトは白枠くっきり */
  .bar{height:8px;background:#0f141e;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-top:8px}
  .bar span{display:block;height:100%;width:0%}
  .bar.p span{background:var(--p)} .bar.f span{background:var(--f)} .bar.c span{background:var(--c)}
  .light .bar{background:#fff;border:1.5px solid #d7e2ef}

  .tab{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
  .tab button{background:transparent;border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px}
  .tab button.active{background:var(--acc);color:#fff;border-color:transparent}
  .disabled{opacity:.55;pointer-events:none;filter:saturate(.3)}

  /* グラフ */
  .chartCard{display:flex;flex-direction:column;align-items:center}
  .chartHeader{display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:10px;margin:6px 0 10px}
  .chartBtns{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
  .chartBtns button{background:transparent;border:1px solid var(--border);color:var(--text)}
  .chartBtns button.active{background:var(--acc);color:#fff;border-color:transparent}
  canvas{width:min(820px,100%);height:auto;display:block;border-radius:10px;margin:0 auto}

  /* フッター強コントラスト */
  .footerNote{color:#f3f6fb;font-weight:600}
  .light .footerNote{color:#2a3d52}
  .footerNote a{color:var(--p);text-decoration:underline}
</style>
</head>
<body>
<header>
  <div>Carnivore Planner, Crafted by Neo</div>
  <button id="themeToggle" style="width:auto;padding:8px 12px;background:transparent;border:1px solid var(--border);color:var(--text)">🌙/☀︎</button>
</header>

<div class="wrap">
  <!-- 入力 -->
  <div class="card">
    <div class="formGrid">
      <div class="pair">
        <div>
          <label>性別</label>
          <select id="sex">
            <option value="" selected disabled>選択してください</option>
            <option value="M">男性</option>
            <option value="F">女性</option>
          </select>
        </div>
        <div>
          <label>年齢（歳）</label>
          <input id="age" type="number" inputmode="decimal" step="0.1" placeholder="例：30" min="12" max="99">
        </div>
      </div>

      <div class="pair">
        <div>
          <label>身長（cm）</label>
          <input id="height" type="number" inputmode="decimal" step="0.1" placeholder="例：170" min="120" max="220">
        </div>
        <div>
          <label>体重（kg）</label>
          <input id="weight" type="number" inputmode="decimal" step="0.1" placeholder="例：65" min="30" max="250">
        </div>
      </div>

      <div class="pair" style="grid-column:1/-1">
        <div>
          <label>目標</label>
          <div class="tab" role="tablist" aria-label="目標">
            <button id="goal-cut" role="tab" aria-selected="false" aria-pressed="false" data-goal="cut">減量</button>
            <button id="goal-maintain" role="tab" aria-selected="true" aria-pressed="true" class="active" data-goal="maintain">維持</button>
            <button id="goal-bulk" role="tab" aria-selected="false" aria-pressed="false" data-goal="bulk">増量</button>
          </div>
        </div>
        <div id="targetCol" style="display:none">
          <label>目標体重（kg）</label>
          <input id="targetWeight" type="number" inputmode="decimal" step="0.1" min="30" max="250" placeholder="例：60">
        </div>
      </div>

      <div class="pair">
        <div>
          <label>タンパク質係数（g/kg）</label>
          <select id="pFactor">
            <option value="" selected disabled>選択してください</option>
            <option value="1.2">1.2（低め）</option>
            <option value="1.6">1.6（標準）</option>
            <option value="2.0">2.0（高め）</option>
          </select>
        </div>
        <div>
          <label>食事法</label>
          <select id="diet">
            <option value="" selected disabled>選択してください</option>
            <option value="Carnivore">CARNIVORE</option>
            <option value="Ketovore">KETOVORE</option>
            <option value="TKD">肉食寄りTKD</option>
          </select>
        </div>
      </div>

      <div class="pair">
        <div>
          <label>運動習慣</label>
          <select id="habit">
            <option value="" selected disabled>選択してください</option>
            <option value="1.2">ほぼ運動しない</option>
            <option value="1.375">週1〜2日</option>
            <option value="1.55">週3〜4日</option>
            <option value="1.725">週5〜6日</option>
            <option value="1.9">毎日/肉体労働</option>
          </select>
        </div>
        <div>
          <label>フィットネス</label>
          <select id="fitnessType" disabled>
            <option value="" selected disabled>選択してください</option>
            <option value="none">該当なし</option>
            <option value="strength">筋トレ</option>
            <option value="run">ランニング</option>
            <option value="cycle">サイクリング</option>
            <option value="club">部活動</option>
            <option value="martial">格闘技</option>
            <option value="aerobic">その他（有酸素運動）</option>
            <option value="anaerobic">その他（無酸素運動）</option>
          </select>
        </div>
      </div>

      <div class="pair">
        <div>
          <label>オン/オフ</label>
          <select id="onoff" disabled>
            <option value="" selected disabled>選択してください</option>
            <option value="none">該当なし</option>
            <option value="on">運動日</option>
            <option value="off">休息日</option>
          </select>
        </div>
        <div id="carbCol" style="display:none">
          <label>糖質摂取量（目安）</label>
          <select id="carbIntake">
            <option value="30" selected>〜30g</option>
            <option value="50">〜50g</option>
            <option value="70">〜70g</option>
          </select>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <button id="calcBtn" aria-pressed="false">計算</button>
    </div>
  </div>

  <!-- 出力：基礎データ（3つ横並び） -->
  <div class="card" id="baseCard" style="display:none" aria-live="polite">
    <h3>基礎データ</h3>
    <div class="grid3">
      <div class="kpi"><div class="small">BMI</div><b id="bmi">–</b></div>
      <div class="kpi"><div class="small">BMR（基礎代謝 kcal）</div><b id="bmr">–</b></div>
      <div class="kpi"><div class="small">TDEE（総消費 kcal）</div><b id="tdee">–</b></div>
    </div>
    <div class="small" id="bmiClassTxt" style="margin-top:8px;opacity:.9"></div>
  </div>

  <!-- 出力：あなたの目安（摂取kcalの下にP/F/C横並び） -->
  <div class="card" id="macroCard" style="display:none" aria-live="polite">
    <h3>あなたの目安（<span id="dietLabel">—</span>）</h3>
    <div class="kpi" style="margin:6px 0 12px">
      <span class="small">摂取カロリー</span>
      <b class="big" id="kcal">–</b><span class="small">kcal/日</span>
    </div>
    <div class="grid3">
      <div class="kpi">
        <div class="small">タンパク質</div>
        <b id="p">–</b><div class="small">g/日</div>
        <div style="margin-top:6px"><b id="pkcal">–</b> <span class="small">kcal</span></div>
        <div class="bar p"><span id="pbar"></span></div>
      </div>
      <div class="kpi">
        <div class="small">脂質</div>
        <b id="f">–</b><div class="small">g/日</div>
        <div style="margin-top:6px"><b id="fkcal">–</b> <span class="small">kcal</span></div>
        <div class="bar f"><span id="fbar"></span></div>
      </div>
      <div class="kpi">
        <div class="small">糖質</div>
        <b id="c">–</b><div class="small">g/日</div>
        <div style="margin-top:6px"><b id="ckcal">–</b> <span class="small">kcal</span></div>
        <div class="bar c"><span id="cbar"></span></div>
      </div>
    </div>
    <div class="small" id="macroNote" style="margin-top:6px;opacity:.95"></div>
    <div class="warn" id="fatWarn" style="display:none"></div>
  </div>

  <!-- 食材：3カテゴリ（画像の並び） -->
  <div class="card" id="foodCard" style="display:none" aria-live="polite">
    <h3>食材別の目安摂取量</h3>
    <div class="grid3">
      <div class="kpi">
        <div class="small">肉・魚・魚介類</div>
        <b id="gGroup1">–</b><div class="small">g</div>
        <div class="small">≈ <b id="kGroup1">–</b> kcal</div>
        <div class="bar p"><span id="grp1bar"></span></div>
      </div>
      <div class="kpi">
        <div class="small">卵・乳製品</div>
        <b id="gGroup2">–</b><div class="small">g</div>
        <div class="small">≈ <b id="kGroup2">–</b> kcal</div>
        <div class="bar f"><span id="grp2bar"></span></div>
      </div>
      <div class="kpi">
        <div class="small">野菜・果物・ナッツ類</div>
        <b id="gGroup3">–</b><div class="small">g</div>
        <div class="small">≈ <b id="kGroup3">–</b> kcal</div>
        <div class="bar c"><span id="grp3bar"></span></div>
      </div>
    </div>
    <div class="small" style="margin-top:8px;opacity:.95">
      ※100gあたり代表値（目安）：肉 220kcal / 魚介類 150kcal / 卵 150kcal / 乳製品 270kcal / 野菜 30kcal / 果物 60kcal / ナッツ 600kcal
    </div>
  </div>

  <p class="small footerNote" style="margin-top:20px">
    ※各プランはカーニボア食・ケトジェニック食を支持する医師・医学博士らの文献・著書・研究のもと設計しています。<br>
    参考: Virta Health（<a href="https://www.youtube.com/@VirtaHealth" target="_blank" rel="noopener">YouTube</a>） / The Noakes Foundation（<a href="https://www.youtube.com/@TheNoakesFoundation" target="_blank" rel="noopener">YouTube</a>）
  </p>
</div>

<script>
const $ = id => document.getElementById(id);

/* ===== テーマ ===== */
function applyThemeFromStorage(){ const t=localStorage.getItem('theme'); document.body.classList.toggle('light', t==='light'); updateThemeBtn(); if(window._lastDrawArgs) drawWeightChart(window._lastDrawArgs); }
function toggleTheme(){ const isLight=document.body.classList.toggle('light'); localStorage.setItem('theme', isLight?'light':'dark'); updateThemeBtn(); if(window._lastDrawArgs) drawWeightChart(window._lastDrawArgs); }
function updateThemeBtn(){ $('themeToggle').textContent = document.body.classList.contains('light') ? '☀︎/🌙' : '🌙/☀︎'; }
$('themeToggle').addEventListener('click', toggleTheme); applyThemeFromStorage();

/* ===== UI：糖質欄 ===== */
function toggleCarb(){ const diet=$('diet').value; $('carbCol').style.display=(diet==='Ketovore'||diet==='TKD')?'block':'none'; }
$('diet').addEventListener('change', toggleCarb);

/* ===== 目標＆目標体重 ===== */
let goal='maintain';
const GOAL_FACTOR={maintain:1.00,cut:0.90,bulk:1.10};
["goal-cut","goal-maintain","goal-bulk"].forEach(id=>{
  $(id).addEventListener('click',e=>{
    ["goal-cut","goal-maintain","goal-bulk"].forEach(i=>{ $(i).classList.remove('active'); $(i).setAttribute('aria-selected','false'); $(i).setAttribute('aria-pressed','false'); });
    e.currentTarget.classList.add('active'); e.currentTarget.setAttribute('aria-selected','true'); e.currentTarget.setAttribute('aria-pressed','true');
    goal = e.currentTarget.dataset.goal;
    $('targetCol').style.display = (goal==='maintain')?'none':'block';
  });
});

/* ===== 「ほぼ運動しない」→ フィットネス/オンオフ＝該当なし & ロック ===== */
function enforceHabitRules(){
  const habit=$('habit').value;
  const dis = (habit==='1.2');
  $('fitnessType').disabled = dis || !habit;
  $('onoff').disabled = dis || !habit;
  if(dis){
    $('fitnessType').value='none';
    $('onoff').value='none';
  }else{
    if($('fitnessType').value==='none') $('fitnessType').value='';
    if($('onoff').value==='none') $('onoff').value='';
  }
}
$('habit').addEventListener('change',()=>{ enforceHabitRules(); });

/* ===== 入力保持（軽） ===== */
function saveForm(){
  const d={sex:$('sex').value,age:$('age').value,height:$('height').value,weight:$('weight').value,
  pFactor:$('pFactor').value,diet:$('diet').value,habit:$('habit').value,fitnessType:$('fitnessType').value,onoff:$('onoff').value,
  carb:$('carbIntake').value,goal,target:$('targetWeight').value};
  localStorage.setItem('plannerForm',JSON.stringify(d));
}
(function restore(){
  const raw=localStorage.getItem('plannerForm'); if(!raw) return;
  try{
    const d=JSON.parse(raw);
    ['sex','age','height','weight','pFactor','diet','habit','fitnessType','onoff','carbIntake','targetWeight'].forEach(k=>{ if(d[k]) $(k).value=d[k]; });
    goal=d.goal||'maintain'; ["goal-cut","goal-maintain","goal-bulk"].forEach(i=>{ const b=$(i); const is=(b.dataset.goal===goal); b.classList.toggle('active',is); b.setAttribute('aria-selected',is?'true':'false'); b.setAttribute('aria-pressed',is?'true':'false'); });
    $('targetCol').style.display=(goal==='maintain')?'none':'block';
  }catch{}
})();

/* ===== バリデーション ===== */
function requireFilled(){
  const miss=[];
  if(!$('sex').value) miss.push('性別');
  if(!$('age').value) miss.push('年齢');
  if(!$('height').value) miss.push('身長');
  if(!$('weight').value) miss.push('体重');
  if(!$('pFactor').value) miss.push('タンパク質係数');
  if(!$('diet').value) miss.push('食事法');
  if(!$('habit').value) miss.push('運動習慣');
  if($('habit').value && $('habit').value!=='1.2'){
    if(!$('fitnessType').value) miss.push('フィットネス');
    if(!$('onoff').value) miss.push('オン/オフ');
  }
  if(miss.length){ alert('未入力があります：\n・'+miss.join('\n・')); return false; }
  return true;
}
function validateTarget(goal, w, tStr){
  if(goal==='maintain') return true;
  const t=+tStr; if(!t){ alert('目標体重を入力してください'); return false; }
  if(goal==='bulk' && t<w){ alert('増量を選択中ですが、目標体重が現在より低いです。修正してください。'); return false; }
  if(goal==='cut'  && t>w){ alert('減量を選択中ですが、目標体重が現在より高いです。修正してください。'); return false; }
  return true;
}

/* ===== 係数 ===== */
const SPORT_FACTORS={none:{on:1.00,off:1.00},strength:{on:1.06,off:0.99},run:{on:1.08,off:0.99},cycle:{on:1.09,off:0.99},club:{on:1.10,off:0.99},martial:{on:1.12,off:0.99},aerobic:{on:1.07,off:0.99},anaerobic:{on:1.05,off:0.99}};
function dailyAdjustment(habit, fitnessType, onoff){ if(habit==='1.2') return 1.00; const map=SPORT_FACTORS[fitnessType||'none']||SPORT_FACTORS.none; return map[onoff||'off']??1.00; }
function carbsBy(diet, carbSel){ return (diet==='Carnivore')?8:(carbSel||30); }
function classText(bmi){ if(bmi<18.5) return "低体重(<18.5)"; if(bmi<25) return "普通(18.5–24.9)"; if(bmi<30) return "前肥満(25–29.9)"; if(bmi<35) return "肥満I(30–34.9)"; if(bmi<40) return "肥満II(35–39.9)"; return "肥満III(≥40)"; }

/* 食材 kcal/100g */
const KCAL={meat:220, fish:150, eggs:150, dairy:270, veg:30, fruit:60, nuts:600};
/* 肉メイン比率（7カテゴリ） */
function splits7By(diet, carbSel, fitnessType, onoff){
  const level=(carbSel<=30)?30:(carbSel<=50)?50:70;
  let s={meat:0.60, fish:0.12, eggs:0.12, dairy:0.10, veg:0.04, fruit:0.01, nuts:0.01};
  if(diet==='Carnivore'){ s={meat:0.66, fish:0.16, eggs:0.12, dairy:0.06, veg:0, fruit:0, nuts:0}; }
  else if(diet==='Ketovore'){
    if(level===30) s={meat:0.58, fish:0.14, eggs:0.12, dairy:0.10, veg:0.05, fruit:0.00, nuts:0.01};
    if(level===50) s={meat:0.54, fish:0.14, eggs:0.11, dairy:0.10, veg:0.08, fruit:0.02, nuts:0.01};
    if(level===70) s={meat:0.50, fish:0.14, eggs:0.11, dairy:0.10, veg:0.11, fruit:0.03, nuts:0.01};
  }else{
    if(level===30) s={meat:0.56, fish:0.14, eggs:0.11, dairy:0.10, veg:0.07, fruit:0.01, nuts:0.01};
    if(level===50) s={meat:0.52, fish:0.14, eggs:0.10, dairy:0.10, veg:0.10, fruit:0.03, nuts:0.01};
    if(level===70) s={meat:0.48, fish:0.14, eggs:0.10, dairy:0.10, veg:0.13, fruit:0.04, nuts:0.01};
  }
  if(onoff==='on'){
    if(['run','cycle','aerobic','club'].includes(fitnessType)){ s.fish+=0.02; s.veg+=0.02; s.fruit+=0.01; s.meat-=0.05; }
    else if(['strength','anaerobic','martial'].includes(fitnessType)){ s.meat+=0.03; s.eggs+=0.02; s.dairy+=0.01; s.veg-=0.03; s.fruit-=0.03; }
  }else if(onoff==='off'){ s.dairy+=0.02; s.meat-=0.02; }
  const sum=Object.values(s).reduce((a,b)=>a+b,0)||1; for(const k in s){ s[k]=Math.max(0,s[k]/sum); } return s;
}

/* 棒グラフ */
function updateBars(pk,fk,ck,total){ const P=total?Math.round(pk/total*100):0; const F=total?Math.round(fk/total*100):0; const C=total?Math.round(ck/total*100):0; $('pbar').style.width=P+'%'; $('fbar').style.width=F+'%'; $('cbar').style.width=C+'%'; }
function updateFoodBars(k1,k2,k3,total){ $('grp1bar').style.width=(total?Math.round(k1/total*100):0)+'%'; $('grp2bar').style.width=(total?Math.round(k2/total*100):0)+'%'; $('grp3bar').style.width=(total?Math.round(k3/total*100):0)+'%'; }

/* グラフ（縦軸は4ラベル） */
function fitCanvasDPR(cv){ const dpr=Math.max(1,window.devicePixelRatio||1); const r=cv.getBoundingClientRect(); const w=Math.max(360,Math.round(r.width*dpr)); const h=Math.max(240,Math.round(r.height*dpr)); if(cv.width!==w||cv.height!==h){ cv.width=w; cv.height=h; } }
function noise(n){ return Math.sin(n*1.7)*0.6 + Math.sin(n*0.37)*0.4; }
function drawWeightChart({startKg,targetKg,months,dailyDeltaKcal,kcalPerKg}){
  const cv=$('wtChart'); fitCanvasDPR(cv); const ctx=cv.getContext('2d'); const W=cv.width,H=cv.height; ctx.clearRect(0,0,W,H);
  const base=(dailyDeltaKcal*30)/(kcalPerKg||7700);
  const xs=[],ys=[]; let w=startKg;
  for(let m=0;m<=months;m++){ const adapt=Math.pow(0.85,m); let d=base*adapt + 0.15*noise(m);
    if(targetKg!=null){ const gap=targetKg-w; d=d*0.5+gap*0.2; if(Math.abs(gap)<0.2) d=gap*0.5; }
    xs.push(m); ys.push(Math.max(0,w)); w+=d;
  }
  const padL=64,padR=22,padT=22,padB=42, plotW=W-padL-padR, plotH=H-padT-padB;
  const minY=Math.floor(Math.min(...ys,targetKg??ys[0])-1), maxY=Math.ceil(Math.max(...ys,targetKg??ys[0])+1), range=Math.max(1,maxY-minY);
  const xTo=m=>padL+(m/months)*plotW, yTo=kg=>padT+(1-(kg-minY)/range)*plotH;

  // グリッド
  const css=getComputedStyle(document.body); ctx.strokeStyle=css.getPropertyValue('--grid').trim(); ctx.lineWidth=1;
  const ySteps=3; // ④ 4ラベル（0..3）
  for(let i=0;i<=ySteps;i++){ const v=minY+(range/ySteps)*i, yy=yTo(v); ctx.beginPath(); ctx.moveTo(padL,yy); ctx.lineTo(W-padR,yy); ctx.stroke(); }
  // 軸
  ctx.strokeStyle=css.getPropertyValue('--axisLine').trim(); ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(padL,yTo(minY)); ctx.lineTo(W-padR,yTo(minY)); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(padL,yTo(minY)); ctx.lineTo(padL,padT); ctx.stroke();
  // ラベル
  ctx.fillStyle=css.getPropertyValue('--axis').trim(); ctx.font=`${Math.round(W/60)+11}px system-ui`;
  const ticks = months<=1? [0,7,14,21,30] : months<=3? [0,30,60,90] : months<=6? [0,60,120,180] : [0,90,180,270,360];
  ticks.forEach(d=>{ const m=d/30, xx=xTo(Math.min(months,m)), label=`${d}日`, tw=ctx.measureText(label).width, xSafe=Math.min(Math.max(xx-tw/2,padL),W-padR-tw); ctx.fillText(label,xSafe,H-12); });
  for(let i=0;i<=ySteps;i++){ const v=minY+(range/ySteps)*i, yy=yTo(v), label=`${v.toFixed(1)}kg`, tw=ctx.measureText(label).width; ctx.fillText(label,Math.max(padL-tw-6,6),yy-4); }

  if(targetKg!=null){ ctx.strokeStyle='#ff7575'; ctx.setLineDash([6,6]); ctx.beginPath(); ctx.moveTo(padL,yTo(targetKg)); ctx.lineTo(W-padR,yTo(targetKg)); ctx.stroke(); ctx.setLineDash([]); }

  // クリッピング
  ctx.save(); ctx.beginPath(); ctx.rect(padL,padT,plotW,plotH); ctx.clip();
  ctx.strokeStyle='#48d1b5'; ctx.lineWidth=3; ctx.beginPath();
  xs.forEach((m,i)=>{ const xx=xTo(m),yy=yTo(ys[i]); if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy); }); ctx.stroke();
  ctx.fillStyle='#48d1b5'; xs.forEach((m,i)=>{ const xx=xTo(m),yy=yTo(ys[i]); ctx.beginPath(); ctx.arc(xx,yy,2.5,0,Math.PI*2); ctx.fill(); });
  ctx.restore();

  window._lastDrawArgs={startKg,targetKg,months,dailyDeltaKcal,kcalPerKg};
}
window.addEventListener('resize',()=>{ if(window._lastDrawArgs) drawWeightChart(window._lastDrawArgs); });

/* ===== 計算 ===== */
$('calcBtn').addEventListener('click', calc);
function calc(){
  // 必須入力
  if(!requireFilled()) return;

  const sex=$('sex').value, age=+$('age').value||0, h=+$('height').value||0, w=+$('weight').value||0;
  if(goal!=='maintain' && !validateTarget(goal,w,$('targetWeight').value)) return;

  const af=+($('habit').value)||1.2, diet=$('diet').value, carbSel=+($('carbIntake').value||30);
  const isNoHabit=$('habit').value==='1.2';
  let fitnessType=isNoHabit?'none':$('fitnessType').value;
  let onoff=isNoHabit?'none':$('onoff').value;
  const pFactor=+($('pFactor').value);
  toggleCarb(); enforceHabitRules();

  // 代謝
  const bmi=w/Math.pow(h/100,2);
  const bmr=(sex==='M')?(10*w+6.25*h-5*age+5):(10*w+6.25*h-5*age-161);
  const dayF=dailyAdjustment($('habit').value,fitnessType,onoff);
  const tdee=bmr*af*dayF;

  // 目標補正
  const gF=GOAL_FACTOR[goal]||1.0, targetKcal=tdee*gF;

  // マクロ
  let protein_g=w*pFactor, carb_g=carbsBy(diet,carbSel);
  let fat_g=(targetKcal-4*protein_g-4*carb_g)/9;
  let pk=protein_g*4, ck=carb_g*4, fk, kcal;

  if(fat_g<0){
    const pcK=pk+ck, s=Math.max(0,targetKcal/(pcK||1));
    protein_g*=s; carb_g*=s; fat_g=0; pk=protein_g*4; ck=carb_g*4; fk=0; kcal=targetKcal;
    $('fatWarn').textContent='※脂質が負になったため、目標カロリーを優先し、タンパク質/糖質を自動調整しました（脂質=0）。';
    $('fatWarn').style.display='block';
  }else{ fk=fat_g*9; kcal=pk+ck+fk; $('fatWarn').style.display='none'; }

  // 表示
  $('bmi').textContent=bmi.toFixed(2);
  $('bmr').textContent=Math.round(bmr).toLocaleString();
  $('tdee').textContent=Math.round(tdee).toLocaleString();
  $('bmiClassTxt').textContent=`BMI区分：${classText(bmi)}｜タンパク質 ${pFactor.toFixed(1)}g/kg｜数値補正 ×${(dayF*gF).toFixed(2)}`;

  $('dietLabel').textContent=(diet==='TKD'?'肉食寄りTKD':diet.toUpperCase());
  $('kcal').textContent=Math.round(kcal).toLocaleString();
  $('p').textContent=Math.round(protein_g); $('f').textContent=Math.round(fat_g); $('c').textContent=Math.round(carb_g);
  $('pkcal').textContent=Math.round(pk).toLocaleString(); $('fkcal').textContent=Math.round(fk).toLocaleString(); $('ckcal').textContent=Math.round(ck).toLocaleString();

  const fitMap={none:'該当なし',strength:'筋トレ',run:'ランニング',cycle:'サイクリング',club:'部活動',martial:'格闘技',aerobic:'その他（有酸素運動）',anaerobic:'その他（無酸素運動）'};
  const onoffTxt=(onoff==='none')?'該当なし':(onoff==='on'?'運動日':'休息日');
  $('macroNote').textContent=`フィットネス：${fitMap[fitnessType]} ｜ 糖質摂取量（目安）：${diet==='Carnivore'?'5〜10g':carbSel+'g'} ｜ 数値補正 ×${(dayF*gF).toFixed(2)}`;

  $('baseCard').style.display='block'; $('macroCard').style.display='block';

  // 食材（7カテゴリ→3つに集計）
  const sp=splits7By(diet,carbSel,fitnessType,onoff);
  const kMeat=kcal*sp.meat, kFish=kcal*sp.fish, kEggs=kcal*sp.eggs, kDairy=kcal*sp.dairy, kVeg=kcal*sp.veg, kFruit=kcal*sp.fruit, kNuts=kcal*sp.nuts;
  const gMeat=(kMeat/KCAL.meat*100), gFish=(kFish/KCAL.fish*100), gEggs=(kEggs/KCAL.eggs*100), gDairy=(kDairy/KCAL.dairy*100), gVeg=(kVeg/KCAL.veg*100), gFruit=(kFruit/KCAL.fruit*100), gNuts=(kNuts/KCAL.nuts*100);

  const k1=kMeat+kFish, k2=kEggs+kDairy, k3=kVeg+kFruit+kNuts;
  const g1=Math.round((gMeat+gFish)/10)*10, g2=Math.round((gEggs+gDairy)/10)*10, g3=Math.round((gVeg+gFruit+gNuts)/10)*10;

  $('gGroup1').textContent=(diet==='Carnivore'&&k1===0)?0:g1; $('kGroup1').textContent=Math.round(k1);
  $('gGroup2').textContent=g2; $('kGroup2').textContent=Math.round(k2);
  $('gGroup3').textContent=(diet==='Carnivore'?0:g3); $('kGroup3').textContent=Math.round(k3);

  $('foodCard').style.display='block';
  updateBars(pk,fk,ck,kcal); updateFoodBars(k1,k2,k3,kcal);

  // グラフ
  const targetKg = (goal!=='maintain' && +$('targetWeight').value>0) ? +$('targetWeight').value : null;
  drawWeightChart({startKg:w, targetKg, months:1, dailyDeltaKcal:(kcal-tdee), kcalPerKg:7700}); // 初回は1ヶ月
  saveForm();
}
</script>
</body>
</html>
